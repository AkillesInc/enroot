#! /bin/bash

# Copyright (c) 2018, NVIDIA CORPORATION. All rights reserved.

set -euo pipefail
shopt -s lastpipe

readonly XDG_DATA_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}"
readonly XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-${HOME}/.config}"
readonly XDG_CACHE_HOME="${XDG_CACHE_HOME:-${HOME}/.cache}"
readonly XDG_RUNTIME_DIR="${XDG_RUNTIME_DIR:-/run}"

readonly ENROOT_VERSION="@version@"

config() { eval "export $1=\${$1:-$2}"; }

config ENROOT_LIBEXEC_PATH  "@libexecdir@"
config ENROOT_SYSCONF_PATH  "@sysconfdir@"
config ENROOT_CONFIG_PATH   "${XDG_CONFIG_HOME}/enroot"
config ENROOT_CACHE_PATH    "${XDG_CACHE_HOME}/enroot"
config ENROOT_DATA_PATH     "${XDG_DATA_HOME}/enroot"
config ENROOT_RUNTIME_PATH  "${XDG_RUNTIME_DIR}/enroot"

config ENROOT_GZIP_PROG     "$(command -v pigz > /dev/null && echo pigz || echo gzip)"
config ENROOT_SQUASH_OPTS   "-comp lzo -noD"
config ENROOT_INIT_SHELL    "/bin/sh"
config ENROOT_ROOTFS_RW     ""
config ENROOT_REMAP_ROOT    ""

(umask 077 && mkdir -p "${ENROOT_CONFIG_PATH}" "${ENROOT_CACHE_PATH}" "${ENROOT_DATA_PATH}" "${ENROOT_RUNTIME_PATH}")

export PATH="${PATH}:${ENROOT_LIBEXEC_PATH}/utils"
source "${ENROOT_LIBEXEC_PATH}/common.sh"
source "${ENROOT_LIBEXEC_PATH}/docker.sh"
source "${ENROOT_LIBEXEC_PATH}/runtime.sh"

for cmd in curl jq parallel mksquashfs unsquashfs tar "${ENROOT_GZIP_PROG}"; do
    command -v "${cmd}" > /dev/null || err "Command not found: ${cmd}"
done

enroot::usage() {
    cat <<EOF
Usage: ${0##*/} COMMAND [ARG...]

 Commands:
    version
    import [--output|-o IMAGE] URI
    export [--output|-o IMAGE] NAME
    create [--name|-n NAME] IMAGE
    start [--root|-r] [--rw|-w] [--conf|-c CONFIG] NAME [COMMAND] [ARG...]
    list [--fancy|-f]
    remove [--force|-f] NAME...
EOF
    exit 0
}

enroot::version() {
    echo "${ENROOT_VERSION}"
}

enroot::import() {
    local uri=""
    local filename=""

    while [ $# -gt 0 ]; do
        case "$1" in
        -o|--output)
            [ -z "${2-}" ] && enroot::usage
            filename="$2"
            shift 2
            ;;
        -?*)
            enroot::usage
            ;;
        --)
            shift
            break
            ;;
        *)
            break
            ;;
        esac
    done
    if [ $# -lt 1 ]; then
        enroot::usage
    fi
    uri="$1"

    runtime::import "${uri}" "${filename}"
}

enroot::export() {
    local name=""
    local filename=""

    while [ $# -gt 0 ]; do
        case "$1" in
        -o|--output)
            [ -z "${2-}" ] && enroot::usage
            filename="$2"
            shift 2
            ;;
        -?*)
            enroot::usage
            ;;
        --)
            shift
            break
            ;;
        *)
            break
            ;;
        esac
    done
    if [ $# -lt 1 ]; then
        enroot::usage
    fi
    name="$1"

    runtime::export "${name}" "${filename}"
}

enroot::create() {
    local image=""
    local name=""

    while [ $# -gt 0 ]; do
        case "$1" in
        -n|--name)
            [ -z "${2-}" ] && enroot::usage
            name="$2"
            shift 2
            ;;
        -?*)
            enroot::usage
            ;;
        --)
            shift
            break
            ;;
        *)
            break
            ;;
        esac
    done
    if [ $# -lt 1 ]; then
        enroot::usage
    fi
    image="$1"

    runtime::create "${image}" "${name}"
}

enroot::start() {
    local name=""
    local config=""

    while [ $# -gt 0 ]; do
        case "$1" in
        -c|--conf)
            [ -z "${2-}" ] && enroot::usage
            config="$2"
            shift 2
            ;;
        -r|--root)
            ENROOT_REMAP_ROOT="true"
            shift
            ;;
        -w|--rw)
            ENROOT_ROOTFS_RW="true"
            shift
            ;;
        -?*)
            enroot::usage
            ;;
        --)
            shift
            break
            ;;
        *)
            break
            ;;
        esac
    done
    if [ $# -lt 1 ]; then
        enroot::usage
    fi
    name="$1"
    shift

    runtime::start "${name}" "${config}" "$@"
}

enroot::list() {
    local fancy=""

    while [ $# -gt 0 ]; do
        case "$1" in
        -f|--fancy)
            fancy="true"
            shift
            ;;
        -?*)
            enroot::usage
            ;;
        --)
            shift
            break
            ;;
        *)
            break
            ;;
        esac
    done

    runtime::list "${fancy}"
}

enroot::remove() {
    local name=""
    local force=""

    while [ $# -gt 0 ]; do
        case "$1" in
        -f|--force)
            force="true"
            shift
            ;;
        -?*)
            enroot::usage
            ;;
        --)
            shift
            break
            ;;
        *)
            break
            ;;
        esac
    done
    if [ $# -lt 1 ]; then
        enroot::usage
    fi

    for name in "$@"; do
        runtime::remove "${name}" "${force}"
    done
}

if [ $# -lt 1 ]; then
    enroot::usage
fi
command="$1"; shift

case "${command}" in
version)
    enroot::version "$@"
    ;;
import)
    enroot::import "$@"
    ;;
export)
    enroot::export "$@"
    ;;
create)
    enroot::create "$@"
    ;;
start)
    enroot::start "$@"
    ;;
list)
    enroot::list "$@"
    ;;
remove)
    enroot::remove "$@"
    ;;
*)
    enroot::usage
    ;;
esac

exit 0
